//#region Home >> Loader

var firstLoad = true;

$("#iframe-0").on('load', function (event) {

    if (firstLoad) {

        setTimeout(function () {
            firstLoad = false;

            if (window.RedirectUrl) {
                var caption = GetQueryname(window.RedirectUrl, 'Caption');

                if (caption == '') {
                    caption = "Ekran";
                }

                createTab('9999998', caption, window.RedirectUrl);
            }


            AjaxStandartCall("GetUserDefaultCommand", '', '', GetUserDefaultCommand_Callback);


        }, 10);

    }

});


function GetQueryname(url,name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    var results = regex.exec(url);
    if (results == null) return "";
    else return results[1];
}


function GetUserDefaultCommand_Callback(result) {

    if (result != '' && result != null) {

        var defaultCommandParam = result.split('|');

        createTab(defaultCommandParam[0], defaultCommandParam[1], defaultCommandParam[2]);
    }

    $("#app-content-loader").animate({
        opacity: 0
    }, 250, function () {
        $("#app-content-loader").css("z-index", "-9999");
    });

}

//#endregion

//#region Home >> Tab

var tabIndex = 0;
var tabClicked = false;
var createdIFrameId;
var clickedIFrameId;
var iframeLoaded;

var tabList = $('#tab-outer-frame').scrollTabs({
    click_callback: tabClickCallback
});

$.contextMenu({
    selector: '.main-tab',
    animation: { duration: 250, show: "fadeIn", hide: "fadeOut" },
    callback: function (key, options) {

        var activeIFrame = $("iframe.active");
        var targetId = $(options.$trigger[0]).attr('id');

        targetId = targetId.split('-')[1];

        if (key == "close" || key == "refresh" || key == "opennewtab") {

            if ($("#tab-" + targetId).hasClass("tab_selected")) {

                hideIFrame(activeIFrame)
                    .then(function () {

                        $("#dashboard-button").click();

                        $("#iframe-" + targetId).remove();
                        tabList.removeTabs("#tab-" + targetId);

                    })

            } else {

                $("#iframe-" + targetId).remove();
                tabList.removeTabs("#tab-" + targetId);
            }

            if (key == "refresh") {

                OpenMenuWithTargetId(targetId)
            }

            if (key == "opennewtab") {

                OpenNewTab(activeIFrame[0].src);
            }

        } else if (key == "allclose") {

            $("#dashboard-button").click();

            $(".main-iframe").remove();
            tabList.removeTabs(".main-tab");

        }

    },
    items: {
        "opennewtab": { name: "Yeni Sekmede Aç", icon: "far fa-external-link-square-alt" },
        "refresh": { name: "Yenile", icon: "fas fa-sync-alt" },
        "close": { name: "Kapat", icon: "far fa-times" },
        "allclose": { name: "Tümünü Kapat", icon: "far fa-times-square" },
        "sep1": "---------",
        "cancel": { name: "Vazgeç", icon: "fas fa-arrow-left" }
    }
});

var TmpParentNode = null;
var TmpNode = null;

function createTab(id, name, url, isBlank) {

    if (isBlank == 1) {

        window.open(
            url,
            '_blank'
        );
    }
    else {


        if (GetMainWindow().glbMakroSaving) {
            var menuMakroStr = "HizliMenüAç('" + url + "', '" + id + "', '" + name + "')";

            GetMainWindow().Makropush(menuMakroStr);
        }

        if (TmpParentNode != null) {
            TmpParentNode.style.backgroundColor = "";
            TmpParentNode.style.borderRadius = "";
            TmpParentNode.children[0].style.backgroundColor = "";

            if (TmpParentNode.children.length > 1) {
                TmpParentNode.children[1].style.backgroundColor = "";
                TmpParentNode.children[1].children[0].style.color = "";
            }
            if (TmpNode != null) {
                TmpNode.style.color = "black";
            }
        }

        var count = 0;

        $("a[href*='MenuId=" + id + "']").each(function () {
            try {
                if (this.href.indexOf("=" + id + "'") == -1)
                    return;

                if (this.className.indexOf("history_link") != -1)
                    return;

                count++;

                if (count > 1)
                    return;

                TmpParentNode = this.parentNode;


                if (TmpParentNode.id != "") {
                    return;
                }

                TmpNode = this.children[0];

                TmpParentNode.style.backgroundColor = "#FF392E";
                TmpParentNode.style.borderRadius = "0px 25px 25px 0px";


                TmpParentNode.children[0].style.backgroundColor = "#FF392E";

                if (TmpParentNode.children.length > 1) {
                    TmpParentNode.children[1].style.backgroundColor = "#FF392E";
                }
                if (TmpNode != null) {
                    TmpNode.style.color = "white";
                }
                return;
            }
            catch
            {

            }
        });

        createdIFrameId = "iframe-" + id;
        clickedIFrameId = "iframe-" + id;

        var tabId = "tab-" + id;
        var tabSelector = "#" + tabId;
        var tabOuterSelector = "#tab-outer-frame";
        var tab = $(tabSelector);

        var iframeId = "iframe-" + id;
        var iframeSelector = "#" + iframeId;
        var iframe = $(iframeSelector);

        var activeIFrame = $("iframe.active");

        //TODO: SD: iframe de scrollar kaldırılacak. yalnızca dikey scroll olmalı. yataylar grid üzerinde olacak.
        var newIFrame = $('<iframe id="' + iframeId + '" src="' + url + '" frameborder="0" scrolling="no" class="main-iframe" style="position: absolute; opacity:0; z-index:-1;"></iframe>');

        if (tab && tab.length > 0) {

            tab.click();

            hideIFrame(activeIFrame)
                .then(function () {

                    showIFrame(iframe);

                });

        }
        else {

            tabIndex++;
            tabList.addTab('<span id="' + tabId + '" index="' + tabIndex + '" class="main-tab" onmousedown="tabMouseDown(event)"><div class="tab-dot"></div><div class="div-tab-name" title="' + name + '">' + name + '</div><i class="far fa-times tab-close-button" onclick="tabCloseButtonClick(event)"></i></span>');

            tabList.clickTab($(tabSelector)[0], $(tabOuterSelector)[0]);

            addNewIFrame(newIFrame, activeIFrame);

        }

    }
}

function showDashboard() {

    clickedIFrameId = "iframe-0";

    var id = 0;
    var iframeId = "iframe-" + id;
    var iframeSelector = "#" + iframeId;
    var iframe = $(iframeSelector);

    var activeIFrame = $("iframe.active");
    var activeIFrameId = activeIFrame.attr("id");

    var dashboardButton = $("#dashboard-button");

    if (iframeId !== activeIFrameId && activeIFrameId) {

        hideIFrame(activeIFrame)
            .then(function () {
                showIFrame(iframe);
            });

    } else {
        showIFrame(iframe);
    }

    clearTabSelections();
    dashboardButton.addClass("active");

}

function activeDashboardButton() {
    var dashboardButton = $("#dashboard-button");
    dashboardButton.addClass("active");
}

function passiveDashboardButton() {
    var dashboardButton = $("#dashboard-button");
    dashboardButton.removeClass("active");
}

function clickDashboardButton() {
    var dashboardButton = $("#dashboard-button");
    dashboardButton.click();
}

function tabClickCallback(e) {

    var id = $(e.target.parentNode).attr("id") ? $(e.target.parentNode).attr("id").replace("tab-", "") : null;

    if (!id) {

        id = $(e.target).attr("id") ? $(e.target).attr("id").replace("tab-", "") : null;
    }

    var iframeId = "iframe-" + id;
    var iframeSelector = "#" + iframeId;
    var iframe = $(iframeSelector);

    clickedIFrameId = iframeId;

    if (!id)
        return false;

    tabClicked = true;

    var activeIFrame = $("iframe.active");
    var activeIFrameId = activeIFrame.attr("id");

    var tabId = "tab-" + id;
    var tabSelector = "#" + tabId;
    var tabOuterSelector = "#tab-outer-frame";

    if (iframeId !== activeIFrameId && activeIFrameId) {

        hideIFrame(activeIFrame)
            .then(function () {

                showIFrame(iframe);

                clickedIFrameId = iframeId;
                tabList.clickTab($(tabSelector)[0], $(tabOuterSelector)[0]);

                tabClicked = false;

            });

    } else {

        showIFrame(iframe);
        tabClicked = false;

    }

}

function tabClick(id) {

    var tabSelector = "#" + id;
    var tab = $(tabSelector);

    tab.click();
}

function tabMouseDown(event) {

    if (event.which == 2) {

        var closeingId = $(event.target.parentNode).attr('id');

        closeingId = closeingId.split('-')[1];

        closeTab(closeingId);

    }

}

function tabMouseWheel(iFrame) {

    iFrame.contents().find('.card-header').on("wheel", function (event) {

        event.preventDefault();

        var deltaY = event.originalEvent.deltaY;
        var selectedTab = $(".main-tab.tab_selected");

        if (deltaY >= 100) {

            var nextEl = selectedTab.next();

            if (nextEl && nextEl.prop('nodeName') == "SPAN") {
                nextEl.click();
            }

        } else if (deltaY <= -100) {

            var prevEl = selectedTab.prev();

            if (prevEl && prevEl.prop('nodeName') == "SPAN") {
                prevEl.click();
            }

        }

        event.stopPropagation();

    });

}

function tabCloseButtonClick(event) {

    var closeingId = $(event.target).closest(".main-tab").attr('id');

    if (closeingId) {
        closeTab(closeingId.split('-')[1]);
    }
}

function closeTab(id) {

    if (!id)
        return false;

    var tabId = "#tab-" + id;
    var tab = $(tabId);
    var iframeId = "#iframe-" + id;
    var iframe = $(iframeId);
    var activeIFrame = $("iframe.active");
    var activeIFrameId = activeIFrame.attr("id");

    if (tab.hasClass("tab_selected")) {

        if (iframeId !== activeIFrameId && activeIFrameId) {

            hideIFrame(activeIFrame)
                .then(function () {

                    activeRightTab(id);

                    iframe.remove();
                    tabList.removeTabs(tabId);
                })
        } else {

            activeRightTab(id);

            iframe.remove();c
            tabList.removeTabs(tabId);
        }

    } else {

        iframe.remove();
        tabList.removeTabs(tabId);

    }

}

function closeActiveTab() {

    var target = $(".main-iframe.active");
    var targetId = target ? target.attr('id') : null;

    if (!targetId)
        return false;

    var iframeId = "#iframe-" + targetId.split('-')[1];

    var closeFrame= $(iframeId);

    if (closeFrame.length>0) {

        var aktiveWindow = closeFrame[0].contentWindow;

        if (aktiveWindow.isGridChange) {
            UyumConfirmNew(LangInf.GNL.WarrningTitle, LangInf.GNL.IsGridChangeWarning, LangInf.GNL.OK, LangInf.GNL.Cancel, callback_closeActiveTab, null, targetId.split('-')[1]);
        }
        else {
            closeTab(targetId.split('-')[1]);
        }
    }
}

function callback_closeActiveTab(targetId) {

    closeTab(targetId);
}

function clearTabSelections() {
    $(".scroll_tab_inner .tab_selected").removeClass("tab_selected");
}

function activeRightTab(id) {

    if (!id)
        return false;

    var tabId = "#tab-" + id;
    var tab = $(tabId);

    var nextEl = tab.next();
    var prevEl = tab.prev();

    if (nextEl && nextEl.prop('nodeName') == "SPAN" && nextEl.hasClass("main-tab")) {
        nextEl.click();
    } else if (prevEl && prevEl.prop('nodeName') == "SPAN" && prevEl.hasClass("main-tab")) {
        prevEl.click();
    } else {
        clickDashboardButton();
    }
}

function addNewIFrame(newIFrame, activeIFrame) {

    hideIFrame(activeIFrame)
        .then(function () {
            addIFrame(newIFrame)
                .then(function () {
                    showNewIFrame(newIFrame);
                });
        });

}

function hideIFrame(activeIFrame) {

    var deferred = jQuery.Deferred();
    var activeIFrameId = activeIFrame.attr("id");

    if (activeIFrameId) {

        activeIFrame.animate(
            {
                opacity: 0
            },
            250,
            function () {

                activeIFrame.removeClass("active");
                activeIFrame.css({ "position": "inherit", "display": "none", "z-index": "-1" });

                deferred.resolve();

            }
        );

    } else {

        setTimeout(function () {
            deferred.resolve();
        });

    }

    return deferred.promise();
}

function showNewIFrame(newIFrame) {

    if (createdIFrameId == clickedIFrameId && createdIFrameId == newIFrame.attr("id")) {
        showIFrame(newIFrame);
    }

}

function refreshIFrame(iframe) {

    var deferred = jQuery.Deferred();

    iframeLoaded = function () {
        deferred.resolve();
        iframeLoaded = null;
    }

    iframe[0].contentWindow.location.reload();

    return deferred.promise();
}

function addIFrame(newIFrame) {

    var deferred = jQuery.Deferred();
    var outerFrame = $("#iframe-outer-frame");

    outerFrame.append(newIFrame);

    newIFrame.on('load', function (event) {

        iframeContentInitialize(newIFrame);

        newIFrame.removeClass("loading");

        deferred.resolve();

        if (iframeLoaded) {
            iframeLoaded();
        }

    });

    return deferred.promise();
}

function showIFrame(newIFrame) {

    var allActiveIFrame = $("#iframe-outer-frame .main-iframe.active");

    allActiveIFrame.removeClass("active");
    allActiveIFrame.css({ "position": "inherit", "display": "none", "opacity": "0", "z-index": "-1" });

    newIFrame.addClass("active");
    newIFrame.css({ "position": "inherit", "display": "inherit", "z-index": "1" });
    newIFrame.animate({ opacity: 1 });

    if (newIFrame && newIFrame.attr("id") != "iframe-0")
        passiveDashboardButton();

}

function checkIFrameLoading() {

    loading = false;
    loadingIFrames = null;

    loadingIFrames = $("#iframe-outer-frame iframe.loading");

    if (loadingIFrames && loadingIFrames.length > 0)
        loading = true;

    return loading;
}



function toggleHistoryBackground() {

    var iframeLoader = $("#app-history-background");

    if (iframeLoader.hasClass("active")) {
        hideHistoryBackground();
    }
    else {
        showHistoryBackground();
    }
}

function showHistoryBackground() {

    var iframeLoader = $("#app-history-background");

    iframeLoader.stop(true, true);
    iframeLoader.addClass("active");
    iframeLoader.css("z-index", "9998");
    iframeLoader.animate({ opacity: 1 });
}

function hideHistoryBackground() {

    var iframeLoader = $("#app-history-background");

    iframeLoader.removeClass("active");
    iframeLoader.animate(
        {
            opacity: 0
        },
        50,
        function () {
            iframeLoader.css("z-index", "-9998");
        });
}

function iframeContentInitialize(iframe) {

    tabMouseWheel(iframe);

    iframe.contents().find("#btnClose").click(closeActiveTab);
    iframe.contents().find("#btnCancel").click(closeActiveTab);

}

//#endregion

//#region Home >> User Panel

function signOut() {

    userPanelClose();

    window.location = "login.aspx?SessionState=End";

}

function userPanelClose() {
    ppUser.Hide();
}

//#endregion

//#region Home >> Perfect Scroll

var ps = new PerfectScrollbar('#splHome_0i0_CC');

//var ps1 = new PerfectScrollbar('#ctl20_BranchList_ddlBranchList_DDD_L_D');

//#endregion

function UyumHelpDesk(s, e) {

    userPanelClose();

    createTab('9999999', 'Destek', 'GNL/CustomForms/PortalCRM.aspx?CommandName=PortalCrmCollection.Show&Protocol=' + window.location.protocol);

}

function VideoHelp(helpAdress) {

    window.open(
        helpAdress,
        '_blank'
    );
}

function UpdateSessionInfo(s, e) {

    userPanelClose();
    createTab('665', 'Varsayılan Firma/İşyeri Değiştirme', 'XMLCard.aspx?CommandName=UpdateSessionInfo.Show&amp;M=1');

}

function ChangePassword(s, e) {

    userPanelClose();

    UyumDialog.Open("/XmlCard.aspx?CommandName=UserPasswordChange.Show", ChangePassword_Callback, 50);
}

function ChangePassword_Callback() {

}

function UyumShortcut(s, e) {
    UyumDialog.Open('/WebGeneral/shortcut.pdf');
}

function OnlineUsers(s, e) {

    createTab('9999998', 'Uyum Chat', 'WebGeneral/OnlineUsers.aspx?CommandName=UyumChatCollection.Show');
}

function OnlineUsers_Callback() {
    UyumDialogPopup.SetHeaderText('Chat');
}

function UyumFollow(s, e) {
    UyumDialog.Open('/XmlCard.aspx?CommandName=FollowCollection.Show&Main=1', null, 65);
}

function GetUyumLicense() {

    AjaxStandartCall("GetUserIsAdmin", '', '', GetUserIsAdmin_Callback);
}

function GetUserIsAdmin_Callback(result) {

    if (result=="1") {
        UyumDialog.Open("/XmlCard.aspx?CommandName=GetUyumLicenseCollection.Show&Main=1", GetUyumLicense_Callback);
    }
    else {
        AlertUyum(LangErr.APP.ErrorPerrmission);
    }
}

function GetUyumLicense_Callback() {
    UyumDialogPopup.SetHeaderText('');
}

function ChangeBranchList(s, e) {

    var branchId = 0

    if (s.GetSelectedItem() != null) {

        branchId = s.GetSelectedItem().value;
    }

    AjaxStandartCall('ChangeBranchList', '', branchId);


}

function HistoryMenuLoad() {

    $.fn.reverse = [].reverse;

    var trigger = $("#history-button");
    var mainTarget = $(".history");
    var targetItem = $('.history_item');
    var html = $("html");

    trigger.on("click", function (event) {

        toggleHistoryBackground();

        mainTarget.toggleClass("reveal unreveal");

        targetItem.reverse().each(function (i, el) {
            setTimeout(function () {
                $(el).toggleClass("visible");
            }, i * 10);
        });

        html.on("click", function () {
            targetItem.removeClass("visible");
            mainTarget.removeClass("reveal");
            hideHistoryBackground();
        });

        event.preventDefault();

        event.stopPropagation();
    });
}

function GetHistoryMenu() {

    AjaxStandartCall("GetHistoryMenu", '', '', GetHistoryMenu_CallBack);

}

function GetHistoryMenu_CallBack(result) {

    if (result != null && result != '') {

        var rtn = JSON.parse(result);

        var col1 = rtn.Col1;

        col1 = col1 || [];

        AddHistoryItem(col1, "history-col-1");

        var col2 = rtn.Col2;

        col2 = col2 || [];

        AddHistoryItem(col2, "history-col-2");

        HistoryMenuLoad();
    }

}

function AddHistoryItem(col, targetCol) {

    var colHtml = '';

    col.forEach(function (item) {

        colHtml += '<li class="history_item"><a class="history_link history_link-template" href="' + item.Href + '">' + item.MnuName + '</a> </li>';
    });

    var targetControl = document.getElementById(targetCol);

    targetControl.innerHTML = colHtml;

}

function DeleteHistoryItem(targetCol) {

    var targetControl = document.getElementById(targetCol);

    targetControl.innerHTML = '';

}

function ClearHistoryMenu() {

    AjaxStandartCall("ClearHistoryMenu", '', '', ClearHistoryMenu_CallBack);

}

function ClearHistoryMenu_CallBack(result) {

    DeleteHistoryItem("history-col-1");

    DeleteHistoryItem("history-col-2");
}

$(document).on('page:load', GetHistoryMenu);

$(document).ready(GetHistoryMenu);

$(document).ready(function () {

    if (document.getElementById("iframe-0") != null) {
        document.getElementById("iframe-0").src = "dashboard.aspx";
    }

    document.getElementsByClassName('licensee-company')[0]
        .addEventListener('click', function (event) {
            GetUyumLicense();
        });
});

function Logout(s, e, isConfirm) {

    if (isConfirm) {

        confirm(LangErr.APP.ErrorLogoutMessage, null, Yes_Callback);
    }
    else {
        Yes_Callback();
    }
}

function Yes_Callback(param) {

    CloseOtherPage();

    try {

        $.connection.hub.stop();

    } catch (err) {
        console.log("SignalR bağlantısı kesilemedi.");

        console.log(err);
    }

    setTimeout(function () {
        window.location.href = 'login.aspx?SessionState=logout';

    }, 300);

}

