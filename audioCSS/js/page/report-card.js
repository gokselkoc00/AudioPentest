//#region Card >> Ready

$(document).ready(function () {
    initializeFilter();
});

//#endregion

//#region Card >> Filter

var filter;
var filterHeight;
var filterMarginTop;


function initializeFilter() {

    setTimeout(function () {

        var isFilter;
        var marginTop;

        filter = $(".table-filter-search");

        isFilter = filter && filter.find("#TableFilterTd").length > 0 ? true : false;

        if (isFilter) {

            filterHeight = filter.height();
            filterMarginTop = filter.css('margin-top');

            marginTop = "5px";

            filter.css('margin-top', marginTop);
            filter.addClass("active");

        }

        //TODO: SD - kontrol edilecek

        var opr = getURLParam('OPR');

        if (opr != null && opr != '') {

            $("#btnFilter").css('display', 'none');
        }

    }, 250);

};

function filterClick() {

    if (filter.hasClass("active")) {

        filter.animate({
            marginTop: ((-1 * filterHeight).toString() + "px")
        }, 500);

        filter.removeClass("active");

    } else {

        filter.animate({
            marginTop: filterMarginTop
        }, 500);

        filter.addClass("active");
        perfectScrollTop($(perfectScrollbar.element), 0, 500);

    }

}

function filterShow() {

    if (!filter.hasClass("active")) {

        filter.animate({
            marginTop: filterMarginTop
        }, 500);

        filter.addClass("active");
        perfectScrollTop($(perfectScrollbar.element), 0, 500);

    }

}

function filterHide() {

    if (filter.hasClass("active")) {

        filter.animate({
            marginTop: ((-1 * filterHeight).toString() + "px")
        }, 500);

        filter.removeClass("active");

    }

}

//#endregion



var fireFox = null;
var IsReportInclude = false;
var IsSendMail = false;
var IsWhatsApp = false;
var IsDijitalDamga = false;

function OpenReportMail(reportUrl, defaultEmail,entityCode) {
    var mailForm = new MailForm();
    mailForm.To = '';
    mailForm.CC = '';
    mailForm.BCC = '';
    mailForm.Subject = '';
    mailForm.Body = '';

    if (defaultEmail != undefined) {
        mailForm.To = defaultEmail;
    }
    mailForm.Attach = '';
    mailForm.ReportMode = 1;
    mailForm.EntityCode = entityCode;
    GlbDialogPrm.reportUrl = reportUrl;
    GlbDialogPrm.reportGUID = '';
    SendMailDialog(mailForm, DialogReportMail);
}

function isFireFox() {
    if (fireFox == null) {
        if (navigator.userAgent.indexOf("Firefox") != -1) {
            fireFox = true;
        }
        else {
            fireFox = false;
        }
    }

    return fireFox;
}

function open_window(_url) {
    //alert("ReportCard.aspx ---- 1");
    if (isFireFox()) {
        window.open(_url);
    }
    else {
        window.open(_url);
    }
}

function open_modal_window(_url) {
    //Zamanlama İçin
    //alert("ReportCard.aspx ---- 2");
    window.open(_url);//,window,"dialogHeight: 768px; dialogWidth: 1024px; edge: Raised; center: Yes; help: Yes; resizable: Yes; status: Yes;");
}

function FilterCmbDropDown(s, e) {
    FilterList(null, null, Uyum$('hdnPageCode').value);
}

function btnAddDesign_Click(s, e) {

    var designName = prompt('Dizayn Adı', '');

    if (designName == null || designName == '')
        return;

    ASPxCallback4.SendCallback('15' + '|' + designName);

}


function btnCreateXMLOtherSource_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '20';
        ASPxCallback1.SendCallback(num);
    }
    else {
        alert('Bu rapor türü için oluşturamazsınız.');
    }

}

function btnDeveleporPage_Click() {

    var pageCode = document.getElementById('hdnPageCode').value;

    var openUrl = "/MainList.aspx?CommandName=AppdReportV2Collection.Show&ProcessTypeMode=1&SourceCmdName=CustomerRequestCollection.New&Args=%27AppdReportV2Collection.Show|And;PageCode=@PageCode|@PageCode=" + pageCode + "|PageCode|Id|Id";

    window.open(openUrl);

}

function btn_SendMail_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }
    ASPxLoadingPanel1.Show();

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '12';
    }

    IsSendMail = true;
    ASPxCallback1.SendCallback(num + '|' + 'Mail');

}

function btn_DigitalStamp_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }
    ASPxLoadingPanel1.Show();

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '12';
    }

    IsDijitalDamga = true;
    ASPxCallback1.SendCallback(num + '|' + 'DigitalDamga');

}

function btn_SendWhatsApp_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }

    ASPxLoadingPanel1.Show();

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '12';
    }

    IsWhatsApp = true;
    ASPxCallback1.SendCallback(num + '|' + 'WhatsApp');

}

function btn_ShowReport_Click(s, e) {

    MakroBtbClk(s, e);

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }
    ASPxLoadingPanel1.Show();

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '12';
    }

    ASPxCallback1.SendCallback(num);

}

function btn_ShowReportInclude_Click(s, e) {

    MakroBtbClk(s, e);

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '12';
    }

    IsReportInclude = true;
    ASPxCallback1.SendCallback(num);

    filterHide();

}

function btn_SaveXML_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '13';
        ASPxCallback1.SendCallback(num);
    }
    else {
        ASPxCallback2.SendCallback('1');
    }

}

function btn_SaveExcel_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }

    var num = '0';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '15';
        ASPxCallback1.SendCallback(num);
    }
    else {
        alert('Bu rapor excele atılamaz');
    }

}


function btn_ShowReport0_Click(s, e) {

    if (ASPxClientEdit.ValidateGroup('valid1', true) == false) {
        alert(LangErr.GNL.FillRequiredFields);
        return;
    }
    ASPxLoadingPanel1.Show();

    var num = '11';
    var isOdbc = Uyum$('hdnIsOdbcReport').value;

    if (isOdbc == '1') {
        num = '14';
    }

    ASPxCallback1.SendCallback(num);

}

function ASPxCallback1_CallbackComplete(s, e) {

    if (!IsReportInclude) {

        if (IsSendMail) {

            IsSendMail = false;

            var results = e.result.split('||');

            var entityCode = '';

            if (GetControl('EntityCode') != null) {
                entityCode = GetControlValue('EntityCode');
            }
            else
            if (GetControl('EntityCodeF') != null) {
                entityCode = GetControlValue('EntityCodeF');
            }

            if (entityCode == null) {
                entityCode = '';
            }

            OpenReportMail(results[0], results[1], entityCode);

            return;
        }

        if (IsWhatsApp) {

            IsWhatsApp = false;

            var results = JSON.parse(e.result);

            if (results.MobileTel) {

                SendWhatsapp(results.MobileTel, results.Message);
            }
            else {

                var MessageInfo = "Message=" + decodeURIComponent(results.Message)

                UyumDialog.Open("/XmlCard.aspx?CommandName=SendWhatsAppCollection.Show&" + MessageInfo, null, 75, 75);
            }

            return;
        }

        if (IsDijitalDamga) {

            IsDijitalDamga = false;
            
            UyumDialog.Open("/XmlCard.aspx?CommandName=DGStampSendCollection.Show", null, 50, 50);
            
            return;
        }

        open_window(e.result);

        if (location.href.indexOf('OPR') != -1) {
            close();
        }
    }
    else {

        IsReportInclude = false;

        var iframe = $("#iframe-content iframe");

        if (iframe && iframe.length) {

            iframe.attr('src', e.result)

        } else {

            var makeIframe = document.createElement('iframe');

            makeIframe.setAttribute('src', e.result);
            makeIframe.setAttribute('id', 'frmReport');
            makeIframe.setAttribute('scrolling', 'no');
            makeIframe.setAttribute('border', '0pt');
            makeIframe.setAttribute('border', 'none');
            makeIframe.setAttribute('width', '100%');
            makeIframe.setAttribute('height', '1250px');
            makeIframe.setAttribute('scrolling', 'no');
            makeIframe.setAttribute('onload', document.getElementById('Layout2').style.display = '');
            makeIframe.style.border = 'none'
            makeIframe.classList.add('scroll-not-be-consumed-by-children');

            document.getElementById('iframe-content').appendChild(makeIframe);

            $(makeIframe).on('load', function (event) {
                perfectScrollTop($(perfectScrollbar.element), $('#Layout1').height(), 500);
            });

        }

    }

}

function ASPxCallback1_EndCallback(s, e) {

    ASPxLoadingPanel1.Hide();

    if (window.afterReportLoad) {
        window.afterReportLoad();
    }

}

function SaveFilter_Click(s, e) {

    FilterSave();

    filterHide();
}

function DeleteFilter_Click() {
    FilterDelete();

    filterShow();
}

function btnUpdateFromUyumsoft_Click() {
    ShowDialog();
    ASPxCallback4.SendCallback('16' + '|' + 'UpdateFromUyumsoft');
}